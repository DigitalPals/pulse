{% extends "base.html" %}

{% block title %}Console - Cybex Pulse{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- System Information Cards -->
            <div class="card">
                <div class="card-header">
                    <h3>System Console</h3>
                    <span id="last-updated">Last updated: <span id="update-time-text" class="update-time-text">Just now</span></span>
                </div>
                <div class="grid">
                    <!-- CPU Card -->
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-microchip"></i></div>
                        <h4>CPU load</h4>
                        <div class="stat-value" id="cpu-usage">{{ system_info.cpu.normalized_load_avg[0]|int if system_info.cpu.normalized_load_avg else system_info.cpu.percent|int }}%</div>
                        <div class="progress-container">
                            <div class="progress-bar" id="cpu-progress" style="width: {{ system_info.cpu.normalized_load_avg[0]|int if system_info.cpu.normalized_load_avg else system_info.cpu.percent|int }}%;"></div>
                        </div>
                        <div class="stat-detail">
                            <small>{{ system_info.cpu.count }} cores | {{ system_info.cpu.model }}</small>
                        </div>
                    </div>
                    
                    <!-- Memory Card -->
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-memory"></i></div>
                        <h4>Memory usage</h4>
                        <div class="stat-value" id="memory-usage">{{ system_info.memory.percent|int }}%</div>
                        <div class="progress-container">
                            <div class="progress-bar" id="memory-progress" style="width: {{ system_info.memory.percent|int }}%;"></div>
                        </div>
                        <div class="stat-detail">
                            <small>{{ (system_info.memory.used / 1024 / 1024 / 1024)|round(1) }} GB / {{ (system_info.memory.total / 1024 / 1024 / 1024)|round(1) }} GB</small>
                        </div>
                    </div>
                    
                    <!-- Disk Card -->
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-hdd"></i></div>
                        <h4>Disk usage</h4>
                        <div class="stat-value" id="disk-usage">{{ system_info.disk.percent|int }}%</div>
                        <div class="progress-container">
                            <div class="progress-bar" id="disk-progress" style="width: {{ system_info.disk.percent|int }}%;"></div>
                        </div>
                        <div class="stat-detail">
                            <small>{{ (system_info.disk.used / 1024 / 1024 / 1024)|round(1) }} GB / {{ (system_info.disk.total / 1024 / 1024 / 1024)|round(1) }} GB</small>
                        </div>
                    </div>
                </div>
            </div>
            </div>
            
            <!-- Console Output Card -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <h5 class="mb-0 mr-3">Console Output</h5>
                        <span id="console-status" class="badge badge-primary ml-2">Connected</span>
                    </div>
                    <div class="console-controls">
                        <div class="console-filter">
                            <select id="log-level-filter" class="form-control form-control-sm">
                                <option value="all">All logs</option>
                                <option value="error">Errors only</option>
                                <option value="info">Info only</option>
                            </select>
                        </div>
                        <div class="console-search">
                            <input type="text" id="console-search" class="form-control form-control-sm" placeholder="Search logs...">
                            <button id="search-btn" class="btn btn-sm btn-secondary">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div class="autoscroll-toggle">
                            <label class="toggle-switch">
                                <input type="checkbox" id="autoscroll-toggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="toggle-label">Auto-scroll</span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="console-output" class="bg-dark text-light p-3 rounded console-container">
                        <div class="text-muted console-message">Connecting to console stream...</div>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between">
                        <div>
                            <button id="clear-btn" class="btn btn-secondary" onclick="clearConsole()">
                                <i class="fas fa-trash"></i> Clear Console
                            </button>
                            <button id="export-btn" class="btn btn-secondary ml-2" onclick="exportLogs()">
                                <i class="fas fa-download"></i> Export Logs
                            </button>
                        </div>
                        <button id="back-btn" class="btn btn-secondary" onclick="window.location.href='/'">
                            <i class="fas fa-arrow-left"></i> Back to Dashboard
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom styles for console page -->
<style>
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    #last-updated {
        font-size: 0.9rem;
        color: var(--text-muted);
    }
    
    .update-time-text {
        font-weight: 500;
    }
    
    .update-time-normal {
        color: var(--text-color);
    }
    
    .update-time-warning {
        color: var(--yellow);
    }
    
    .progress-container {
        width: 100%;
        height: 8px;
        background-color: var(--border-color);
        border-radius: 4px;
        margin: 10px 0;
        overflow: hidden;
    }
    
    .progress-bar {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s ease-in-out;
    }
    
    #cpu-progress {
        background: linear-gradient(90deg, var(--green) 0%, var(--yellow) 70%, var(--red) 100%);
        background-size: 200% 100%;
    }
    
    #memory-progress {
        background: linear-gradient(90deg, var(--green) 0%, var(--yellow) 70%, var(--red) 100%);
        background-size: 200% 100%;
    }
    
    #disk-progress {
        background: linear-gradient(90deg, var(--green) 0%, var(--yellow) 70%, var(--red) 100%);
        background-size: 200% 100%;
    }
    
    .console-container {
        height: 500px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.5;
        padding: 15px;
        position: relative;
    }
    
    .console-message {
        padding: 3px 5px;
        border-radius: 2px;
        margin-bottom: 2px;
        position: relative;
        white-space: pre-wrap;
        word-break: break-word;
    }
    
    .console-message:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }
    
    .console-message.error {
        color: var(--red);
        background-color: rgba(217, 58, 58, 0.1);
        border-left: 3px solid var(--red);
        padding-left: 8px;
    }
    
    .console-message.warning {
        color: var(--yellow);
        background-color: rgba(255, 193, 7, 0.1);
        border-left: 3px solid var(--yellow);
        padding-left: 8px;
    }
    
    .console-message.info {
        color: var(--highlight-blue);
        border-left: 3px solid var(--highlight-blue);
        padding-left: 8px;
    }
    
    .console-message .timestamp {
        color: var(--text-muted);
        font-size: 0.85em;
        margin-right: 8px;
    }
    
    .console-controls {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .console-search {
        display: flex;
        align-items: center;
    }
    
    .console-search input {
        width: 200px;
        margin-right: 5px;
    }
    
    .autoscroll-toggle {
        display: flex;
        align-items: center;
    }
    
    .autoscroll-toggle .toggle-switch {
        margin-right: 5px;
    }
    
    .highlight {
        background-color: rgba(255, 193, 7, 0.3);
        color: white;
        border-radius: 2px;
        padding: 0 2px;
    }
    
    @media (max-width: 768px) {
        .console-controls {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
            margin-top: 10px;
        }
        
        .console-search input {
            width: 150px;
        }
        
        .card-header {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .console-filter, .console-search {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    let consoleEventSource = null;
    let autoScroll = true;
    let allMessages = [];
    let currentFilter = 'all';
    let searchTerm = '';
    
    // Connect to the console stream when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        connectToConsoleStream();
        
        // Set up periodic refresh of system information
        setInterval(refreshSystemInfo, 5000); // Refresh every 5 seconds
        
        // Initialize last updated time
        updateLastUpdated();
        setInterval(updateLastUpdated, 30000); // Update every 30 seconds
        
        // Set up event listeners for controls
        document.getElementById('log-level-filter').addEventListener('change', filterLogs);
        document.getElementById('console-search').addEventListener('input', searchLogs);
        document.getElementById('search-btn').addEventListener('click', searchLogs);
        document.getElementById('autoscroll-toggle').addEventListener('change', function(e) {
            autoScroll = e.target.checked;
            if (autoScroll) {
                scrollToBottom();
            }
        });
        
        // Handle search on enter key
        document.getElementById('console-search').addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                searchLogs();
            }
        });
        
        // Initialize progress bars
        updateProgressBars();
        
        // Handle console scrolling to detect manual scroll
        const consoleOutput = document.getElementById('console-output');
        consoleOutput.addEventListener('scroll', function() {
            // If user scrolls up, disable auto-scroll
            if (consoleOutput.scrollHeight - consoleOutput.scrollTop > consoleOutput.clientHeight + 50) {
                if (autoScroll) {
                    document.getElementById('autoscroll-toggle').checked = false;
                    autoScroll = false;
                }
            }
        });
    });
    
    // Function to update the "last updated" time
    function updateLastUpdated() {
        const updateTimeElement = document.getElementById('update-time-text');
        const now = new Date();
        const lastUpdate = window.lastUpdateTime || now;
        window.lastUpdateTime = now;
        
        const diffInSeconds = Math.floor((now - lastUpdate) / 1000);
        
        let text = 'Just now';
        let className = 'update-time-normal';
        
        if (diffInSeconds < 60) {
            text = 'Just now';
        } else if (diffInSeconds < 300) {
            text = 'Less than 5 minutes ago';
        } else {
            text = 'Over 5 minutes ago';
            className = 'update-time-warning';
        }
        
        updateTimeElement.textContent = text;
        updateTimeElement.className = 'update-time-text ' + className;
    }
    
    // Function to refresh system information
    function refreshSystemInfo() {
        fetch('/api/system-info')
            .then(response => response.json())
            .then(data => {
                updateSystemInfoCards(data);
                updateProgressBars();
                updateLastUpdated();
            })
            .catch(error => {
                console.error('Error fetching system info:', error);
            });
    }
    
    // Function to update system information cards
    function updateSystemInfoCards(data) {
        // Update CPU card with 1-minute load average (rounded to integer)
        const cpuValue = data.cpu.normalized_load_avg ? data.cpu.normalized_load_avg[0] : data.cpu.percent;
        const cpuRounded = Math.round(cpuValue);
        document.getElementById('cpu-usage').textContent = cpuRounded + '%';
        document.getElementById('cpu-progress').style.width = cpuRounded + '%';
        document.getElementById('cpu-progress').style.setProperty('--value', cpuRounded);
        
        // Update CPU details
        const cpuDetailElement = document.querySelector('.stat-card:first-child .stat-detail small');
        if (cpuDetailElement) {
            cpuDetailElement.textContent = `${data.cpu.count} cores | ${data.cpu.model}`;
        }
        
        // Update Memory card (rounded to integer)
        const memRounded = Math.round(data.memory.percent);
        document.getElementById('memory-usage').textContent = memRounded + '%';
        document.getElementById('memory-progress').style.width = memRounded + '%';
        document.getElementById('memory-progress').style.setProperty('--value', memRounded);
        
        // Update memory details
        const memDetailElement = document.querySelector('.stat-card:nth-child(2) .stat-detail small');
        if (memDetailElement) {
            const usedGB = (data.memory.used / 1024 / 1024 / 1024).toFixed(1);
            const totalGB = (data.memory.total / 1024 / 1024 / 1024).toFixed(1);
            memDetailElement.textContent = `${usedGB} GB / ${totalGB} GB`;
        }
        
        // Update Disk card (rounded to integer)
        const diskRounded = Math.round(data.disk.percent);
        document.getElementById('disk-usage').textContent = diskRounded + '%';
        document.getElementById('disk-progress').style.width = diskRounded + '%';
        document.getElementById('disk-progress').style.setProperty('--value', diskRounded);
        
        // Update disk details
        const diskDetailElement = document.querySelector('.stat-card:nth-child(3) .stat-detail small');
        if (diskDetailElement) {
            const usedGB = (data.disk.used / 1024 / 1024 / 1024).toFixed(1);
            const totalGB = (data.disk.total / 1024 / 1024 / 1024).toFixed(1);
            diskDetailElement.textContent = `${usedGB} GB / ${totalGB} GB`;
        }
        
        // Update uptime if available
        if (data.uptime && document.getElementById('uptime-value')) {
            document.getElementById('uptime-value').textContent = data.uptime.uptime_formatted;
        }
    }
    
    // Function to update progress bar colors based on values
    function updateProgressBars() {
        const cpuProgress = document.getElementById('cpu-progress');
        const memoryProgress = document.getElementById('memory-progress');
        const diskProgress = document.getElementById('disk-progress');
        
        // Get current values
        const cpuValue = parseInt(cpuProgress.style.width) || 0;
        const memoryValue = parseInt(memoryProgress.style.width) || 0;
        const diskValue = parseInt(diskProgress.style.width) || 0;
        
        // Set colors based on values
        if (cpuValue < 50) {
            cpuProgress.style.backgroundColor = 'var(--green)';
        } else if (cpuValue < 80) {
            cpuProgress.style.backgroundColor = 'var(--yellow)';
        } else {
            cpuProgress.style.backgroundColor = 'var(--red)';
        }
        
        if (memoryValue < 50) {
            memoryProgress.style.backgroundColor = 'var(--green)';
        } else if (memoryValue < 80) {
            memoryProgress.style.backgroundColor = 'var(--yellow)';
        } else {
            memoryProgress.style.backgroundColor = 'var(--red)';
        }
        
        if (diskValue < 50) {
            diskProgress.style.backgroundColor = 'var(--green)';
        } else if (diskValue < 80) {
            diskProgress.style.backgroundColor = 'var(--yellow)';
        } else {
            diskProgress.style.backgroundColor = 'var(--red)';
        }
    }
    
    function connectToConsoleStream() {
        // Close any existing connection
        if (consoleEventSource) {
            consoleEventSource.close();
            consoleEventSource = null;
        }
        
        // Connect to the SSE endpoint
        try {
            consoleEventSource = new EventSource('/console-stream');
            
            // Handle connection open
            consoleEventSource.onopen = function() {
                document.getElementById('console-status').textContent = 'Connected';
                document.getElementById('console-status').className = 'badge badge-success';
                appendToConsole("Connected to console stream", "info");
            };
            
            // Handle messages
            consoleEventSource.addEventListener('message', function(event) {
                try {
                    const data = JSON.parse(event.data);
                    appendToConsole(data.message, data.is_error ? "error" : "info");
                } catch (e) {
                    appendToConsole("Error parsing message: " + e.message, "error");
                }
            });
        } catch (e) {
            appendToConsole("Failed to connect to console stream: " + e.message, "error");
            document.getElementById('console-status').textContent = 'Connection Failed';
            document.getElementById('console-status').className = 'badge badge-danger';
        }
        
        // Handle errors
        consoleEventSource.addEventListener('error', function(event) {
            try {
                // Only try to parse data if it exists
                if (event.data) {
                    const data = JSON.parse(event.data);
                    appendToConsole(data.message, "error");
                } else {
                    // Handle case where event.data is undefined
                    appendToConsole("Error receiving console data from server", "error");
                }
            } catch (e) {
                // Handle JSON parsing errors
                appendToConsole("Error processing console data: " + e.message, "error");
            }
        });
        
        // Handle connection errors
        consoleEventSource.onerror = function(event) {
            // Check if the connection was never established
            if (consoleEventSource.readyState === 0) {
                appendToConsole('Failed to connect to console stream. Please try again.', "error");
                document.getElementById('console-status').textContent = 'Connection Failed';
                document.getElementById('console-status').className = 'badge badge-danger';
            }
            // Check if the connection was lost after being established
            else if (consoleEventSource.readyState === 2) {
                appendToConsole('Connection to console stream lost. Attempting to reconnect...', "warning");
                document.getElementById('console-status').textContent = 'Disconnected';
                document.getElementById('console-status').className = 'badge badge-warning';
                
                // Try to reconnect after a short delay
                setTimeout(connectToConsoleStream, 3000);
            }
        };
    }
    
    function appendToConsole(message, type) {
        // Store message in our array
        const timestamp = new Date().toISOString().replace('T', ' ').substr(0, 19);
        const messageObj = {
            message: message,
            type: type,
            timestamp: timestamp
        };
        allMessages.push(messageObj);
        
        // Check if this message should be displayed based on current filter
        if (shouldDisplayMessage(messageObj)) {
            addMessageToDOM(messageObj);
        }
    }
    
    function addMessageToDOM(messageObj) {
        const consoleOutput = document.getElementById('console-output');
        const messageElement = document.createElement('div');
        
        messageElement.className = `console-message ${messageObj.type}`;
        
        // Add timestamp
        const timestampSpan = document.createElement('span');
        timestampSpan.className = 'timestamp';
        timestampSpan.textContent = messageObj.timestamp;
        messageElement.appendChild(timestampSpan);
        
        // Add message with appropriate icon
        let icon = '';
        if (messageObj.type === 'error') {
            icon = '<i class="fas fa-exclamation-triangle"></i> ';
        } else if (messageObj.type === 'warning') {
            icon = '<i class="fas fa-exclamation-circle"></i> ';
        } else if (messageObj.type === 'info') {
            icon = '<i class="fas fa-info-circle"></i> ';
        }
        
        const messageContent = document.createElement('span');
        messageContent.className = 'message-content';
        messageContent.innerHTML = icon + messageObj.message;
        
        // Highlight search term if present
        if (searchTerm && messageObj.message.toLowerCase().includes(searchTerm.toLowerCase())) {
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            messageContent.innerHTML = icon + messageObj.message.replace(regex, '<span class="highlight">$1</span>');
        }
        
        messageElement.appendChild(messageContent);
        consoleOutput.appendChild(messageElement);
        
        // Auto-scroll to bottom if enabled
        if (autoScroll) {
            scrollToBottom();
        }
    }
    
    function scrollToBottom() {
        const consoleOutput = document.getElementById('console-output');
        consoleOutput.scrollTop = consoleOutput.scrollHeight;
    }
    
    function clearConsole() {
        const consoleOutput = document.getElementById('console-output');
        consoleOutput.innerHTML = '<div class="console-message text-muted">Console cleared</div>';
        allMessages = [];
    }
    
    function filterLogs() {
        const filter = document.getElementById('log-level-filter').value;
        currentFilter = filter;
        
        // Clear current display
        const consoleOutput = document.getElementById('console-output');
        consoleOutput.innerHTML = '';
        
        // Re-add messages that match the filter
        allMessages.forEach(msg => {
            if (shouldDisplayMessage(msg)) {
                addMessageToDOM(msg);
            }
        });
        
        if (autoScroll) {
            scrollToBottom();
        }
    }
    
    function searchLogs() {
        searchTerm = document.getElementById('console-search').value.trim();
        
        // Clear current display
        const consoleOutput = document.getElementById('console-output');
        consoleOutput.innerHTML = '';
        
        // Re-add messages that match both filter and search
        allMessages.forEach(msg => {
            if (shouldDisplayMessage(msg)) {
                addMessageToDOM(msg);
            }
        });
        
        if (autoScroll) {
            scrollToBottom();
        }
    }
    
    function shouldDisplayMessage(msg) {
        // Check if message passes the current filter
        if (currentFilter !== 'all' && msg.type !== currentFilter) {
            return false;
        }
        
        // Check if message contains search term
        if (searchTerm && !msg.message.toLowerCase().includes(searchTerm.toLowerCase())) {
            return false;
        }
        
        return true;
    }
    
    function exportLogs() {
        // Create a formatted string of all logs
        let logText = "Cybex Pulse Console Logs - Exported " + new Date().toISOString() + "\n\n";
        
        allMessages.forEach(msg => {
            logText += `[${msg.timestamp}] [${msg.type.toUpperCase()}] ${msg.message}\n`;
        });
        
        // Create a blob and download link
        const blob = new Blob([logText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = 'cybex-pulse-logs-' + new Date().toISOString().replace(/:/g, '-') + '.txt';
        document.body.appendChild(a);
        a.click();
        
        // Clean up
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);
    }
    
    // Clean up event source when leaving the page
    window.addEventListener('beforeunload', function() {
        if (consoleEventSource) {
            consoleEventSource.close();
        }
    });
</script>
{% endblock %}